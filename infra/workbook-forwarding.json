{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workbookName": { "type": "string" },
    "location": { "type": "string" },
    "appInsightsResourceId": { "type": "string" }
  },
  "resources": [
    {
      "type": "Microsoft.Insights/workbooks",
      "apiVersion": "2022-04-01",
      "name": "[parameters('workbookName')]",
      "location": "[parameters('location')]",
      "kind": "shared",
      "properties": {
        "displayName": "Forwarding health (Function â†’ Logic App)",
        "sourceId": "[parameters('appInsightsResourceId')]",
        "serializedData": "{\n  \"version\": \"Notebook/1.0\",\n  \"items\": [\n    {\n      \"type\": 1,\n      \"name\": \"Title\",\n      \"content\": {\n        \"json\": \"## Forwarding health\\nTracks forwarding successes and failures from the EventGrid proxy Function to the Logic App.\"\n      }\n    },\n    {\n      \"type\": 3,\n      \"name\": \"SuccessCount\",\n      \"content\": {\n        \"version\": \"KqlItem/1.0\",\n        \"title\": \"Forward successes (last 30 min)\",\n        \"query\": \"traces\\n| where timestamp > ago(30m)\\n| where message contains \\\"Forwarded to Logic App. Status: 200\\\" or message contains \\\"Forwarded to Logic App. Status: 202\\\"\\n| summarize Success=count()\",\n        \"visualization\": \"stat\",\n        \"resourceType\": \"microsoft.insights/components\",\n        \"resources\": [\n          \"[parameters('appInsightsResourceId')]\"\n        ]\n      }\n    },\n    {\n      \"type\": 3,\n      \"name\": \"FailureCount\",\n      \"content\": {\n        \"version\": \"KqlItem/1.0\",\n        \"title\": \"Forward failures (last 30 min)\",\n        \"query\": \"traces\\n| where timestamp > ago(30m)\\n| where message contains \\\"Forwarded to Logic App\\\"\\n| where message !contains \\\"Status: 200\\\" and message !contains \\\"Status: 202\\\"\\n| summarize Failures=count()\",\n        \"visualization\": \"stat\",\n        \"resourceType\": \"microsoft.insights/components\",\n        \"resources\": [\n          \"[parameters('appInsightsResourceId')]\"\n        ]\n      }\n    },\n    {\n      \"type\": 3,\n      \"name\": \"RecentFailures\",\n      \"content\": {\n        \"version\": \"KqlItem/1.0\",\n        \"title\": \"Recent forwarding failures (last 2h)\",\n        \"query\": \"traces\\n| where timestamp > ago(2h)\\n| where message contains \\\"Forwarded to Logic App\\\"\\n| where message !contains \\\"Status: 200\\\" and message !contains \\\"Status: 202\\\"\\n| project timestamp, message\\n| order by timestamp desc\",\n        \"visualization\": \"table\",\n        \"resourceType\": \"microsoft.insights/components\",\n        \"resources\": [\n          \"[parameters('appInsightsResourceId')]\"\n        ]\n      }\n    }\n  ],\n  \"isLocked\": false\n}"
      }
    }
  ],
  "outputs": {
    "workbookResourceId": {
      "type": "string",
      "value": "[resourceId('Microsoft.Insights/workbooks', parameters('workbookName'))]"
    }
  }
}

