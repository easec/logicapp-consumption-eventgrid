{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workbookId": {
      "type": "string"
    },
    "location": {
      "type": "string"
    }
  },
  "resources": [
    {
      "type": "Microsoft.Insights/workbooks",
      "apiVersion": "2022-04-01",
      "name": "[parameters('workbookId')]",
      "location": "[parameters('location')]",
      "kind": "shared",
      "properties": {
        "displayName": "Forwarding health (Function â†’ Logic App)",
        "serializedData": {
          "version": "Notebook/1.0",
          "items": [
            {
              "type": 1,
              "name": "Title",
              "content": {
                "json": "## Forwarding health\nTracks forwarding successes and failures from the EventGrid proxy Function to the Logic App."
              }
            },
            {
              "type": 3,
              "name": "SuccessCount",
              "content": {
                "version": "KqlItem/1.0",
                "query": "traces\n| where timestamp > ago(30m)\n| where message contains \"Forwarded to Logic App. Status: 200\" or message contains \"Forwarded to Logic App. Status: 202\"\n| summarize Success=count()",
                "size": 0,
                "title": "Forward successes (last 30 min)",
                "visualization": "stat",
                "resourceType": "microsoft.insights/components",
                "resources": [
                  "/subscriptions/0ac447d7-fbc3-4d3d-84d4-37bb9a71e089/resourceGroups/rg-iscala-archive/providers/Microsoft.Insights/components/fa-iscala-eg-proxy-dev"
                ]
              }
            },
            {
              "type": 3,
              "name": "FailureCount",
              "content": {
                "version": "KqlItem/1.0",
                "query": "traces\n| where timestamp > ago(30m)\n| where message contains \"Forwarded to Logic App\"\n| where message !contains \"Status: 200\" and message !contains \"Status: 202\"\n| summarize Failures=count()",
                "size": 0,
                "title": "Forward failures (last 30 min)",
                "visualization": "stat",
                "resourceType": "microsoft.insights/components",
                "resources": [
                  "/subscriptions/0ac447d7-fbc3-4d3d-84d4-37bb9a71e089/resourceGroups/rg-iscala-archive/providers/Microsoft.Insights/components/fa-iscala-eg-proxy-dev"
                ]
              }
            },
            {
              "type": 3,
              "name": "RecentFailures",
              "content": {
                "version": "KqlItem/1.0",
                "query": "traces\n| where timestamp > ago(2h)\n| where message contains \"Forwarded to Logic App\"\n| where message !contains \"Status: 200\" and message !contains \"Status: 202\"\n| project timestamp, message\n| order by timestamp desc",
                "size": 1,
                "title": "Recent forwarding failures",
                "visualization": "table",
                "resourceType": "microsoft.insights/components",
                "resources": [
                  "/subscriptions/0ac447d7-fbc3-4d3d-84d4-37bb9a71e089/resourceGroups/rg-iscala-archive/providers/Microsoft.Insights/components/fa-iscala-eg-proxy-dev"
                ]
              }
            }
          ],
          "isLocked": false
        }
      }
    }
  ]
}


